"""
Evaluate StyleGAN3 Discriminator on Real vs Fake datasets
---------------------------------------------------------
This script loads the pretrained StyleGAN3-T (FFHQ 1024x1024) discriminator (D)
and evaluates how it scores:
  1Ô∏è‚É£ Real faces from ArtiFact dataset
  2Ô∏è‚É£ Fake faces from ArtiFact dataset
  3Ô∏è‚É£ Fake faces generated by StyleGAN3 (your Colab outputs)

Outputs:
  - Mean ¬± std score per dataset
  - Histogram saved as results/discriminator_scores.png
  - Text summary saved as results/discriminator_summary.txt
"""

# === Fix import path for StyleGAN3 ===
import sys, os, tqdm
from PIL import Image  # Import Image from PIL
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
stylegan3_path = os.path.join(project_root, 'stylegan3')
if stylegan3_path not in sys.path:
    sys.path.insert(0, stylegan3_path)

import dnnlib
import legacy
import torch
from torchvision import transforms
import numpy as np
import matplotlib.pyplot as plt

# === CONFIG ===
MODEL_PATH = r"C:\Users\dalab\Desktop\azimjaan21\DeepHUNTER\fakeface_generator\models\stylegan3-t-ffhq-1024x1024.pkl"
DATA_PATHS = {
    "ArtiFact_Real": "data/artifact/test/real",
    "ArtiFact_Fake": "data/artifact/test/fake",
    "My_StyleGAN3": "data/fake/stylegan3_run01"
}
OUT_DIR = "results"
os.makedirs(OUT_DIR, exist_ok=True)

device = torch.device("cuda" if torch.cuda.is_available() else "cpu")

# === Load Discriminator ===
print("üîπ Loading StyleGAN3 discriminator...")
with open(MODEL_PATH, "rb") as f:
    data = legacy.load_network_pkl(f)
    D = data["D"].eval().requires_grad_(False).to(device)
print("‚úÖ Discriminator loaded successfully.")

# === Preprocessing ===
transform = transforms.Compose([
    transforms.Resize((1024, 1024)),
    transforms.ToTensor(),
    transforms.Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5))
])

def get_score(img_path):
    """Return raw discriminator score (logit)."""
    img = Image.open(img_path).convert("RGB")
    img_t = transform(img).unsqueeze(0).to(device)
    with torch.no_grad():
        score = D(img_t, None)
    return float(score.cpu().item())

def evaluate_folder(folder, label):
    """Compute scores for all images in a folder."""
    if not os.path.exists(folder):
        print(f"‚ö†Ô∏è Missing folder: {folder}")
        return []
    paths = [os.path.join(folder, f) for f in os.listdir(folder)
             if f.lower().endswith((".jpg", ".png"))]
    scores = []
    for p in tqdm(paths, desc=f"Evaluating {label}", ncols=80):
        try:
            scores.append(get_score(p))
        except Exception as e:
            print(f"  ‚ö†Ô∏è Skipped {p}: {e}")
    if len(scores) == 0:
        return []
    mean, std = np.mean(scores), np.std(scores)
    print(f"üìä {label}: mean={mean:.3f}, std={std:.3f}, n={len(scores)}")
    return scores

# === Evaluate all folders ===
all_scores = {}
for label, path in DATA_PATHS.items():
    scores = evaluate_folder(path, label)
    if scores:
        all_scores[label] = scores

# === Plot histogram ===
plt.figure(figsize=(8,6))
for label, scores in all_scores.items():
    plt.hist(scores, bins=40, alpha=0.6, label=label)
plt.xlabel("Discriminator Score (logit)")
plt.ylabel("Image Count")
plt.legend()
plt.title("StyleGAN3 Discriminator Response")
plt.tight_layout()
plt.savefig(os.path.join(OUT_DIR, "discriminator_scores.png"))
plt.close()
print("üìà Saved histogram ‚Üí results/discriminator_scores.png")

# === Save summary text ===
summary_path = os.path.join(OUT_DIR, "discriminator_summary.txt")
with open(summary_path, "w") as f:
    for label, scores in all_scores.items():
        mean, std = np.mean(scores), np.std(scores)
        f.write(f"{label}: mean={mean:.3f}, std={std:.3f}, n={len(scores)}\n")
print(f"üìù Summary saved ‚Üí {summary_path}")

print("\n‚úÖ Evaluation complete!")
